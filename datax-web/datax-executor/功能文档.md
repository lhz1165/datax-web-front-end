# DataX-Executor 功能文档

## 模块概述

`datax-executor` 是 DataX Web 平台的执行器模块，负责接收调度中心的任务触发请求，实际执行 DataX 数据同步任务。执行器采用分布式架构，可以部署多个实例以实现负载均衡和高可用。

## 核心功能

### 1. 任务执行

#### 1.1 任务接收
- **RPC 通信**：通过自定义 RPC 框架接收调度中心的任务触发请求
- **任务参数解析**：解析任务配置、执行参数、增量参数等
- **任务分发**：根据任务类型分发到对应的处理器

#### 1.2 DataX 任务执行
- **JSON 配置生成**：根据任务配置生成 DataX 的 JSON 配置文件
- **临时文件管理**：创建临时 JSON 文件用于 DataX 执行
- **进程启动**：通过 Python 进程启动 DataX 任务
- **进程监控**：监控 DataX 进程的执行状态
- **进程 ID 上报**：将进程 ID 上报给调度中心，用于任务终止

### 2. 命令构建

#### 2.1 DataX 命令构建
- **Python 路径配置**：支持配置 DataX Python 脚本路径
- **JVM 参数支持**：支持传递 JVM 参数给 DataX 进程
- **增量参数构建**：
  - **ID 增量**：构建 ID 范围参数（startId, endId）
  - **时间增量**：构建时间范围参数（startTime, endTime）
  - **分区增量**：构建分区参数（partition field, time offset, format）

#### 2.2 参数格式化
- 支持参数中的空格转义
- 支持参数引号处理
- 支持时间格式转换

### 3. 日志解析

#### 3.1 日志统计
- **实时日志解析**：实时解析 DataX 执行日志
- **统计信息提取**：
  - 任务开始时间
  - 任务结束时间
  - 任务总耗时
  - 平均流量（MB/s）
  - 记录写入速度（条/s）
  - 读出记录总数
  - 读写失败总数

#### 3.2 日志输出
- **标准输出解析**：解析 DataX 的标准输出流
- **错误输出解析**：解析 DataX 的错误输出流
- **日志上报**：将解析的统计信息上报给调度中心

### 4. 任务终止

#### 4.1 进程终止
- **进程 ID 获取**：从任务执行记录中获取进程 ID
- **进程终止**：通过系统命令终止 DataX 进程
- **资源清理**：清理临时文件和资源

### 5. 执行器注册

#### 5.1 自动注册
- **注册到调度中心**：启动时自动注册到调度中心
- **心跳保持**：定期发送心跳保持在线状态
- **地址上报**：上报执行器的 IP 和端口

#### 5.2 配置管理
- **应用名称**：配置执行器应用名称
- **IP 地址**：支持自动获取或手动配置
- **端口配置**：配置执行器服务端口
- **日志路径**：配置任务日志存储路径
- **日志保留**：配置日志保留天数

## 技术架构

### 核心技术栈
- **框架**：Spring Boot 2.x
- **RPC**：自定义 RPC 框架（基于 Netty HTTP）
- **进程管理**：Java Process API
- **日志解析**：正则表达式 + 流处理

### 核心组件

#### 1. ExecutorJobHandler（任务处理器）
- 实现 `IJobHandler` 接口
- 负责接收任务触发请求
- 执行 DataX 任务
- 解析日志统计信息

#### 2. BuildCommand（命令构建器）
- 构建 DataX 执行命令
- 处理增量参数
- 格式化命令参数

#### 3. LogStatistics（日志统计）
- 日志统计信息实体
- 包含任务执行的各种统计指标

#### 4. AnalysisStatistics（日志分析器）
- 解析 DataX 日志
- 提取统计信息
- 格式化输出

#### 5. KillJobHandler（任务终止处理器）
- 处理任务终止请求
- 终止 DataX 进程
- 清理资源

#### 6. DataXConfig（执行器配置）
- 配置执行器参数
- 初始化 RPC 客户端
- 配置日志路径

### 目录结构

```
datax-executor/
├── core/
│   └── config/
│       └── DataXConfig.java        # 执行器配置
├── service/
│   ├── jobhandler/
│   │   ├── ExecutorJobHandler.java # 任务执行处理器
│   │   ├── KillJobHandler.java     # 任务终止处理器
│   │   └── DataXConstant.java      # 常量定义
│   ├── command/
│   │   └── BuildCommand.java       # 命令构建器
│   └── logparse/
│       ├── LogStatistics.java      # 日志统计实体
│       ├── AnalysisStatistics.java # 日志分析器
│       └── LogStatistics.java      # 日志统计
├── util/
│   └── SystemUtils.java            # 系统工具类
└── DataXExecutorApplication.java   # 启动类
```

## 执行流程

### 1. 任务接收流程

```
调度中心 → RPC 调用 → ExecutorJobHandler.execute()
```

### 2. 任务执行流程

```
1. 接收任务参数（TriggerParam）
2. 生成临时 JSON 文件
3. 构建 DataX 执行命令
4. 启动 DataX 进程
5. 上报进程 ID 给调度中心
6. 启动日志解析线程
7. 等待进程执行完成
8. 解析日志统计信息
9. 清理临时文件
10. 返回执行结果
```

### 3. 日志解析流程

```
DataX 标准输出/错误输出
    ↓
BufferedInputStream
    ↓
AnalysisStatistics.analysisStatisticsLog()
    ↓
正则表达式匹配
    ↓
提取统计信息
    ↓
LogStatistics 对象
    ↓
返回给调度中心
```

## 配置说明

### 应用配置（application.yml）

```yaml
server:
  port: 8181

datax:
  job:
    admin:
      # 调度中心地址列表
      addresses: http://localhost:8180
    executor:
      # 执行器应用名称
      appname: datax-executor
      # 执行器 IP（空则自动获取）
      ip:
      # 执行器端口
      port: 9999
      # 任务日志路径
      logpath: ${data.path}/applogs/executor/jobhandler
      # 日志保留天数
      logretentiondays: 30
    # 访问令牌（与调度中心保持一致）
    accessToken:
  
  executor:
    # JSON 临时文件路径
    jsonpath: ${json.path}
  
  # DataX Python 脚本路径
  pypath: /app/datax/datax/bin/datax.py
```

### 环境变量配置

支持通过环境变量配置：
- `data.path`：数据存储路径
- `json.path`：JSON 临时文件路径
- `python.path`：Python 路径（可选）
- `DATAX_HOME`：DataX 安装路径（可选，会自动检测）

### DataX 路径检测

执行器支持自动检测 DataX 安装路径：
1. 优先使用 `DATAX_HOME` 环境变量
2. 其次使用配置的 `pypath`
3. 自动拼接 `bin/datax.py`

## API 接口

### RPC 接口（内部调用）

执行器通过 RPC 框架暴露以下接口：

#### 1. run（执行任务）
- **接口**：`ExecutorBiz.run(TriggerParam)`
- **功能**：执行 DataX 任务
- **参数**：任务触发参数
- **返回**：执行结果和统计信息

#### 2. kill（终止任务）
- **接口**：`ExecutorBiz.kill(int logId)`
- **功能**：终止正在执行的任务
- **参数**：日志 ID
- **返回**：终止结果

#### 3. log（查看日志）
- **接口**：`ExecutorBiz.log(long logDateTim, long logId, int fromLineNum)`
- **功能**：查看任务执行日志
- **参数**：日志时间、日志 ID、起始行号
- **返回**：日志内容

#### 4. idleBeat（心跳检测）
- **接口**：`ExecutorBiz.idleBeat(int jobId)`
- **功能**：检测执行器是否空闲
- **参数**：任务 ID
- **返回**：是否空闲

## 日志统计信息

### LogStatistics 字段说明

| 字段 | 说明 | 示例 |
|------|------|------|
| taskStartTime | 任务开始时间 | 2024-01-01 10:00:00 |
| taskEndTime | 任务结束时间 | 2024-01-01 10:05:00 |
| taskTotalTime | 任务总耗时 | 5分钟 |
| taskAverageFlow | 平均流量 | 10.5 MB/s |
| taskRecordWritingSpeed | 记录写入速度 | 10000 条/s |
| taskRecordReaderNum | 读出记录总数 | 1000000 |
| taskRecordWriteFailNum | 读写失败总数 | 0 |

### 日志解析规则

执行器通过正则表达式解析 DataX 日志中的关键信息：
- 任务开始/结束时间
- 数据传输统计
- 错误信息
- 性能指标

## 部署说明

### 前置条件

1. **DataX 安装**：确保 DataX 已正确安装
2. **Python 环境**：确保 Python 2.7+ 或 Python 3.x 可用
3. **网络连通**：确保执行器能够访问调度中心

### 打包

```bash
mvn clean install -DskipTests
```

### 启动

```bash
./bin/start.sh -m datax-executor
```

### 停止

```bash
./bin/stop.sh -m datax-executor
```

### 多实例部署

支持部署多个执行器实例：
1. 配置不同的端口
2. 使用相同的应用名称（appname）
3. 调度中心会自动负载均衡

## 注意事项

### 1. DataX 路径配置
- 确保 `pypath` 配置正确，指向 DataX 的 `bin/datax.py` 文件
- 或者设置 `DATAX_HOME` 环境变量

### 2. 临时文件管理
- JSON 临时文件会在任务执行完成后自动删除
- 确保 `jsonpath` 目录有写权限
- 建议定期清理临时文件目录

### 3. 进程管理
- 执行器会监控 DataX 进程的执行状态
- 进程 ID 会上报给调度中心，支持远程终止
- 确保系统有足够的资源运行 DataX 进程

### 4. 日志管理
- 任务日志会保存到配置的 `logpath` 目录
- 支持日志保留策略，自动清理过期日志
- 建议配置合理的日志保留天数

### 5. 网络配置
- 确保执行器能够访问调度中心
- 确保执行器能够访问目标数据源
- 如果使用防火墙，需要开放相应端口

### 6. 资源限制
- DataX 任务可能消耗大量内存和 CPU
- 建议根据服务器资源合理配置并发任务数
- 监控系统资源使用情况

### 7. 错误处理
- 执行器会捕获异常并返回错误信息
- 任务执行失败时，会返回详细的错误信息
- 建议查看日志文件获取更详细的错误信息

## 性能优化

### 1. 并发控制
- 根据服务器资源合理配置并发任务数
- 避免同时执行过多任务导致资源耗尽

### 2. 日志优化
- 合理配置日志级别
- 定期清理过期日志
- 使用异步日志写入

### 3. 网络优化
- 确保执行器与调度中心网络延迟低
- 使用内网通信提高性能

## 故障排查

### 1. 任务执行失败
- 检查 DataX 路径配置是否正确
- 检查 Python 环境是否可用
- 查看执行器日志获取详细错误信息

### 2. 无法连接调度中心
- 检查 `admin.addresses` 配置是否正确
- 检查网络连通性
- 检查访问令牌是否匹配

### 3. 进程无法终止
- 检查进程 ID 是否正确
- 检查系统权限
- 手动终止进程

## 版本信息

- **当前版本**：2.1.2
- **Java 版本**：1.8+
- **Spring Boot 版本**：2.x
- **DataX 版本**：支持 DataX 3.0+

