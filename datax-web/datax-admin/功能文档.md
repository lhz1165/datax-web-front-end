# DataX-Admin 功能文档

## 模块概述

`datax-admin` 是 DataX Web 平台的管理端模块，负责任务调度、配置管理、监控统计等核心功能。作为整个系统的控制中心，它提供了完整的 Web 管理界面和 RESTful API 接口。

## 核心功能

### 1. 任务调度管理

#### 1.1 任务配置
- **任务列表管理**：支持分页查询、条件筛选（任务组、状态、描述、类型、项目）
- **任务创建**：支持单个任务创建和批量任务创建
- **任务更新**：支持任务配置的修改
- **任务删除**：支持任务移除
- **任务启停**：支持任务的启动和停止操作
- **任务触发**：支持手动触发任务执行，可覆盖执行参数

#### 1.2 调度功能
- **Cron 表达式支持**：支持标准的 Cron 表达式配置
- **触发时间预览**：可查看近 5 次任务的触发时间
- **调度策略**：
  - 执行器路由策略（FIRST、LAST、ROUND、RANDOM、CONSISTENT_HASH、SHARDING_BROADCAST 等）
  - 阻塞处理策略（SERIAL_EXECUTION、DISCARD_LATER、COVER_EARLY）
- **增量同步支持**：
  - ID 增量同步
  - 时间增量同步
  - 分区增量同步

### 2. 数据源管理

#### 2.1 数据源配置
- **数据源列表**：支持分页查询、排序、筛选
- **数据源增删改查**：完整的 CRUD 操作
- **数据源测试**：支持连接测试，验证数据源配置是否正确
- **多数据库支持**：
  - MySQL
  - PostgreSQL
  - SQL Server
  - Oracle
  - MongoDB
  - Hive
  - HBase
  - 其他 JDBC 兼容数据库

#### 2.2 数据源缓存
- 支持数据源连接缓存，提高查询性能
- 数据源更新时自动清除缓存

### 3. 元数据查询

#### 3.1 数据库元数据
- **Schema 查询**：支持 PostgreSQL 等数据库的 Schema 查询
- **表列表查询**：根据数据源和 Schema 获取表列表
- **视图列表查询**：获取数据库视图列表
- **字段信息查询**：
  - 获取表的所有字段名称
  - 获取字段详细信息（名称、类型、注释、是否可空、是否主键、长度等）
  - 支持通过 SQL 查询获取字段信息
- **索引信息查询**：获取表的索引列表（索引名、类型、字段等）

#### 3.2 表结构管理
- **创建表**：支持 PostgreSQL 和 MySQL 的表创建
- **删除表**：支持表的删除操作
- **修改表结构**：
  - 添加字段
  - 删除字段
  - 修改字段
  - 修改表注释
- **创建视图**：支持视图的创建
- **创建索引**：支持索引的创建

### 4. JSON 配置构建

#### 4.1 DataX JSON 生成
- **可视化构建**：通过 Web 界面可视化构建 DataX 任务 JSON 配置
- **批量构建**：支持基于模板批量创建任务配置
- **Reader/Writer 支持**：
  - RDBMS Reader/Writer（MySQL、PostgreSQL、Oracle、SQL Server 等）
  - Hive Reader/Writer
  - HBase Reader/Writer
  - MongoDB Reader/Writer
  - 其他 DataX 支持的插件

### 5. API 管理

#### 5.1 API 配置
- **API 创建**：支持创建动态 API 配置
- **API 列表**：支持分页查询、状态筛选
- **API 编辑**：支持 API 配置的修改
- **API 删除**：支持 API 的删除操作
- **API 状态管理**：
  - 0：禁用
  - 1：待发布
  - 2：已发布

#### 5.2 动态 API
- **通用接口**：提供 `/api/ds/v1/**` 通用接口，根据配置动态处理请求
- **参数解析**：自动解析请求参数和响应参数配置
- **SQL 构建**：根据配置自动构建 SQL 查询语句
- **数据源执行**：支持从配置的数据源执行 SQL 并返回结果
- **参数绑定**：支持多种操作符（equal、notEqual、like、in、notIn、greaterThan、lessThan 等）

### 6. 任务日志管理

#### 6.1 日志查询
- **日志列表**：支持分页查询任务执行日志
- **日志详情**：查看任务执行的详细日志信息
- **日志统计**：统计任务执行情况

#### 6.2 日志报告
- 自动生成任务执行报告
- 支持日志保留策略配置

### 7. 执行器管理

#### 7.1 执行器注册
- **执行器注册**：执行器自动注册到调度中心
- **执行器监控**：监控执行器的在线状态
- **执行器路由**：根据路由策略选择合适的执行器

#### 7.2 执行器组管理
- **执行器组配置**：支持执行器分组管理
- **地址管理**：支持自动注册和手动录入两种方式

### 8. 项目管理

#### 8.1 项目配置
- **项目列表**：支持项目的增删改查
- **项目关联**：任务可关联到项目，便于管理

### 9. 模板管理

#### 9.1 任务模板
- **模板创建**：支持创建任务模板
- **模板使用**：支持基于模板批量创建任务

### 10. 用户权限管理

#### 10.1 用户管理
- **用户列表**：支持用户的增删改查
- **用户认证**：基于 JWT 的用户认证
- **权限控制**：支持基于角色的权限控制

#### 10.2 角色权限
- **角色管理**：支持角色的增删改查
- **权限分配**：支持为角色分配权限

### 11. 监控统计

#### 11.1 仪表盘
- **任务统计**：显示任务总数、运行中任务数、成功/失败任务数
- **执行器统计**：显示执行器数量、在线执行器数
- **图表展示**：支持任务执行趋势图表展示

#### 11.2 任务监控
- **任务状态监控**：实时监控任务执行状态
- **失败任务监控**：自动监控失败任务并告警
- **执行器监控**：监控执行器在线状态

### 12. 系统配置

#### 12.1 安全配置
- **JWT 认证**：基于 JWT 的 Token 认证机制
- **CORS 配置**：支持跨域请求配置
- **访问控制**：支持路径级别的访问控制

#### 12.2 国际化
- **多语言支持**：支持中文和英文
- **消息配置**：支持自定义消息配置

## 技术架构

### 核心技术栈
- **框架**：Spring Boot 2.x
- **ORM**：MyBatis-Plus
- **数据库**：MySQL（存储任务配置、日志等）
- **安全**：Spring Security + JWT
- **API 文档**：Swagger2
- **RPC**：自定义 RPC 框架（基于 Netty HTTP）

### 核心组件

#### 1. JobScheduler（任务调度器）
- 负责初始化调度系统
- 管理各种监控线程
- 管理执行器客户端连接池

#### 2. JobTrigger（任务触发器）
- 负责触发任务执行
- 处理任务路由策略
- 处理增量同步参数

#### 3. JobScheduleHelper（调度助手）
- 扫描待执行任务
- 触发任务执行

#### 4. JobFailMonitorHelper（失败监控助手）
- 监控失败任务
- 处理失败重试

#### 5. JobRegistryMonitorHelper（注册中心监控助手）
- 监控执行器注册状态
- 清理离线执行器

#### 6. JobLogReportHelper（日志报告助手）
- 生成任务执行报告
- 清理过期日志

### 目录结构

```
datax-admin/
├── config/              # 配置类
│   ├── SecurityConfig.java
│   ├── SwaggerConfig.java
│   └── WebConfig.java
├── controller/          # REST 控制器
│   ├── JobInfoController.java      # 任务管理
│   ├── JobDatasourceController.java # 数据源管理
│   ├── MetadataController.java     # 元数据查询
│   ├── DynamicApiController.java   # 动态API
│   └── ...
├── service/             # 业务逻辑层
│   ├── JobService.java
│   ├── JobDatasourceService.java
│   └── ...
├── mapper/             # 数据访问层
├── entity/              # 实体类
├── core/                # 核心功能
│   ├── scheduler/       # 调度器
│   ├── trigger/         # 触发器
│   ├── thread/          # 线程助手
│   └── route/           # 路由策略
├── tool/                # 工具类
│   ├── database/        # 数据库工具
│   ├── datax/           # DataX 工具
│   └── query/           # 查询工具
└── util/                # 通用工具
```

## API 接口

### 任务管理接口
- `GET /api/job/pageList` - 任务列表（分页）
- `GET /api/job/list` - 全部任务列表
- `POST /api/job/add` - 添加任务
- `POST /api/job/update` - 更新任务
- `POST /api/job/remove/{id}` - 删除任务
- `POST /api/job/start` - 启动任务
- `POST /api/job/stop` - 停止任务
- `POST /api/job/trigger` - 触发任务
- `GET /api/job/nextTriggerTime` - 获取下次触发时间

### 数据源接口
- `GET /api/jobJdbcDatasource` - 数据源列表（分页）
- `GET /api/jobJdbcDatasource/all` - 所有数据源
- `GET /api/jobJdbcDatasource/{id}` - 查询数据源
- `POST /api/jobJdbcDatasource` - 新增数据源
- `PUT /api/jobJdbcDatasource` - 修改数据源
- `DELETE /api/jobJdbcDatasource` - 删除数据源
- `POST /api/jobJdbcDatasource/test` - 测试数据源

### 元数据接口
- `GET /api/metadata/getDBSchema` - 获取 Schema 列表
- `GET /api/metadata/getTables` - 获取表列表
- `GET /api/metadata/getViews` - 获取视图列表
- `GET /api/metadata/getColumns` - 获取字段列表
- `GET /api/metadata/getColumnsInfo` - 获取字段详细信息
- `GET /api/metadata/getIndexes` - 获取索引列表
- `POST /api/metadata/createTable` - 创建表
- `DELETE /api/metadata/dropTable` - 删除表
- `POST /api/metadata/alterTable` - 修改表结构
- `POST /api/metadata/createView` - 创建视图
- `POST /api/metadata/createIndex` - 创建索引

### API 管理接口
- `GET /api/jobApi` - API 列表
- `GET /api/jobApi/{id}` - 查询 API
- `POST /api/jobApi` - 新增 API
- `PUT /api/jobApi` - 修改 API
- `DELETE /api/jobApi` - 删除 API
- `POST /api/jobApi/status` - 更新 API 状态

### 动态 API 接口
- `GET/POST/PUT/DELETE /api/ds/v1/**` - 动态 API 接口（根据配置处理）

## 配置说明

### 应用配置（application.yml）
```yaml
server:
  port: 8180

spring:
  datasource:
    url: jdbc:mysql://localhost:3306/datax_web
    username: root
    password: password

datax:
  job:
    accessToken: # 访问令牌
    i18n: zh_CN  # 国际化语言
```

### 启动参数
- 默认端口：8180
- 默认上下文路径：空
- Swagger 文档：`http://localhost:8180/doc.html`

## 部署说明

### 打包
```bash
mvn clean install -DskipTests
```

### 启动
```bash
./bin/start.sh -m datax-admin
```

### 停止
```bash
./bin/stop.sh -m datax-admin
```

## 注意事项

1. **数据库初始化**：首次启动前需要执行数据库初始化脚本
2. **执行器连接**：确保执行器能够连接到调度中心
3. **数据源配置**：数据源密码支持 AES 加密存储
4. **日志清理**：建议配置日志保留策略，避免日志文件过大
5. **性能优化**：大量任务时建议调整线程池大小和调度扫描间隔

## 版本信息

- **当前版本**：2.1.2
- **Java 版本**：1.8+
- **Spring Boot 版本**：2.x

