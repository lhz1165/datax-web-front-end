(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-38a240a2"],{"49b3":function(e,t,a){"use strict";a.r(t);var n=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"app-container"},[a("el-page-header",{attrs:{content:"修改表"},on:{back:e.goBack}},[a("template",{slot:"content"},[a("span",[e._v("修改表")]),e._v(" "),a("el-tag",{staticStyle:{"margin-left":"10px"},attrs:{size:"small"}},[e._v(e._s(e.datasourceName))]),e._v(" "),e.schema?a("el-tag",{staticStyle:{"margin-left":"5px"},attrs:{size:"small",type:"info"}},[e._v(e._s(e.schema))]):e._e(),e._v(" "),a("el-tag",{staticStyle:{"margin-left":"5px"},attrs:{size:"small",type:"warning"}},[e._v(e._s(e.tableName))])],1)],2),e._v(" "),a("el-card",{staticClass:"form-card"},[a("div",{attrs:{slot:"header"},slot:"header"},[a("span",[e._v("表基本信息")])]),e._v(" "),a("el-form",{ref:"tableForm",attrs:{model:e.tableForm,"label-width":"100px"}},[a("el-row",{attrs:{gutter:20}},[a("el-col",{attrs:{span:8}},[a("el-form-item",{attrs:{label:"表名"}},[a("el-input",{attrs:{disabled:""},model:{value:e.tableForm.tableName,callback:function(t){e.$set(e.tableForm,"tableName",t)},expression:"tableForm.tableName"}})],1)],1),e._v(" "),a("el-col",{attrs:{span:16}},[a("el-form-item",{attrs:{label:"表注释"}},[a("el-input",{attrs:{placeholder:"请输入表注释"},model:{value:e.tableForm.tableComment,callback:function(t){e.$set(e.tableForm,"tableComment",t)},expression:"tableForm.tableComment"}}),e._v(" "),a("el-button",{attrs:{type:"text",size:"small"},on:{click:e.updateTableComment}},[e._v("修改注释")])],1)],1)],1)],1)],1),e._v(" "),a("el-card",{staticClass:"form-card"},[a("div",{staticClass:"card-header",attrs:{slot:"header"},slot:"header"},[a("span",[e._v("现有字段")])]),e._v(" "),a("el-table",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticStyle:{width:"100%"},attrs:{data:e.existingColumns,border:"",stripe:"",size:"small"}},[a("el-table-column",{attrs:{type:"index",label:"序号",width:"60",align:"center"}}),e._v(" "),a("el-table-column",{attrs:{prop:"name",label:"字段名","min-width":"150"}}),e._v(" "),a("el-table-column",{attrs:{prop:"type",label:"数据类型",width:"120"}}),e._v(" "),a("el-table-column",{attrs:{prop:"length",label:"长度",width:"80",align:"center"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v("\n          "+e._s(t.row.length||"-")+"\n        ")]}}])}),e._v(" "),a("el-table-column",{attrs:{prop:"nullable",label:"可为空",width:"80",align:"center"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-tag",{attrs:{type:t.row.nullable?"success":"danger",size:"mini"}},[e._v("\n            "+e._s(t.row.nullable?"是":"否")+"\n          ")])]}}])}),e._v(" "),a("el-table-column",{attrs:{prop:"primaryKey",label:"主键",width:"80",align:"center"},scopedSlots:e._u([{key:"default",fn:function(t){return[t.row.primaryKey?a("el-tag",{attrs:{type:"warning",size:"mini"}},[e._v("是")]):a("span",[e._v("-")])]}}])}),e._v(" "),a("el-table-column",{attrs:{prop:"comment",label:"注释","min-width":"150"}}),e._v(" "),a("el-table-column",{attrs:{label:"操作",width:"150",align:"center",fixed:"right"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-button",{attrs:{type:"text",size:"small",icon:"el-icon-edit"},on:{click:function(a){return e.editColumn(t.row)}}},[e._v("修改")]),e._v(" "),a("el-button",{staticStyle:{color:"#F56C6C"},attrs:{type:"text",size:"small",icon:"el-icon-delete",disabled:t.row.primaryKey},on:{click:function(a){return e.dropColumn(t.row)}}},[e._v("删除")])]}}])})],1)],1),e._v(" "),a("el-card",{staticClass:"form-card"},[a("div",{staticClass:"card-header",attrs:{slot:"header"},slot:"header"},[a("span",[e._v("添加新字段")]),e._v(" "),a("el-button",{attrs:{type:"primary",size:"small",icon:"el-icon-plus"},on:{click:e.addNewColumn}},[e._v("添加字段")])],1),e._v(" "),e.newColumns.length>0?a("el-table",{staticStyle:{width:"100%"},attrs:{data:e.newColumns,border:"",stripe:"",size:"small"}},[a("el-table-column",{attrs:{type:"index",label:"序号",width:"60",align:"center"}}),e._v(" "),a("el-table-column",{attrs:{prop:"name",label:"字段名","min-width":"150"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-input",{attrs:{size:"small",placeholder:"字段名"},model:{value:t.row.name,callback:function(a){e.$set(t.row,"name",a)},expression:"scope.row.name"}})]}}],null,!1,240780900)}),e._v(" "),a("el-table-column",{attrs:{prop:"type",label:"数据类型",width:"140"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-select",{attrs:{size:"small",filterable:"","allow-create":"",placeholder:"类型"},model:{value:t.row.type,callback:function(a){e.$set(t.row,"type",a)},expression:"scope.row.type"}},e._l(e.dataTypeGroups,(function(t){return a("el-option-group",{key:t.label,attrs:{label:t.label}},e._l(t.options,(function(e){return a("el-option",{key:e,attrs:{label:e,value:e}})})),1)})),1)]}}],null,!1,2221207669)}),e._v(" "),a("el-table-column",{attrs:{prop:"length",label:"长度",width:"100"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-input-number",{attrs:{size:"small",min:0,controls:!1,placeholder:"长度"},model:{value:t.row.length,callback:function(a){e.$set(t.row,"length",a)},expression:"scope.row.length"}})]}}],null,!1,2388463860)}),e._v(" "),a("el-table-column",{attrs:{prop:"nullable",label:"可为空",width:"80",align:"center"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-checkbox",{model:{value:t.row.nullable,callback:function(a){e.$set(t.row,"nullable",a)},expression:"scope.row.nullable"}})]}}],null,!1,3348298333)}),e._v(" "),a("el-table-column",{attrs:{prop:"defaultValue",label:"默认值",width:"120"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-input",{attrs:{size:"small",placeholder:"默认值"},model:{value:t.row.defaultValue,callback:function(a){e.$set(t.row,"defaultValue",a)},expression:"scope.row.defaultValue"}})]}}],null,!1,721536204)}),e._v(" "),a("el-table-column",{attrs:{prop:"comment",label:"注释","min-width":"150"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-input",{attrs:{size:"small",placeholder:"注释"},model:{value:t.row.comment,callback:function(a){e.$set(t.row,"comment",a)},expression:"scope.row.comment"}})]}}],null,!1,3310127229)}),e._v(" "),a("el-table-column",{attrs:{label:"操作",width:"80",align:"center",fixed:"right"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-button",{staticStyle:{color:"#F56C6C"},attrs:{type:"text",size:"small",icon:"el-icon-delete"},on:{click:function(a){return e.removeNewColumn(t.$index)}}})]}}],null,!1,452459085)})],1):a("el-empty",{attrs:{description:"暂无新增字段","image-size":60}})],1),e._v(" "),a("div",{staticClass:"footer-actions"},[a("el-button",{on:{click:e.goBack}},[e._v("返回")]),e._v(" "),a("el-button",{attrs:{type:"info",disabled:0===e.newColumns.length},on:{click:e.previewSQL}},[e._v("预览SQL")]),e._v(" "),a("el-button",{attrs:{type:"primary",loading:e.submitting,disabled:0===e.newColumns.length},on:{click:e.handleSubmit}},[e._v("执行修改")])],1),e._v(" "),a("el-dialog",{attrs:{title:"修改表SQL预览",visible:e.sqlDialogVisible,width:"600px"},on:{"update:visible":function(t){e.sqlDialogVisible=t}}},[a("pre",{staticClass:"sql-preview"},[e._v(e._s(e.generatedSQL))]),e._v(" "),a("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[a("el-button",{attrs:{size:"small"},on:{click:function(t){e.sqlDialogVisible=!1}}},[e._v("关闭")]),e._v(" "),a("el-button",{attrs:{size:"small",type:"primary"},on:{click:e.copySQL}},[e._v("复制SQL")])],1)]),e._v(" "),a("el-dialog",{attrs:{title:"修改字段: "+e.editingColumn.name,visible:e.editColumnDialogVisible,width:"500px"},on:{"update:visible":function(t){e.editColumnDialogVisible=t}}},[a("el-form",{attrs:{model:e.editingColumn,"label-width":"80px"}},[a("el-form-item",{attrs:{label:"字段名"}},[a("el-input",{attrs:{placeholder:e.editingColumn.name},model:{value:e.editingColumn.newName,callback:function(t){e.$set(e.editingColumn,"newName",t)},expression:"editingColumn.newName"}})],1),e._v(" "),a("el-form-item",{attrs:{label:"数据类型"}},[a("el-select",{staticStyle:{width:"100%"},attrs:{filterable:"","allow-create":"",placeholder:"类型"},model:{value:e.editingColumn.newType,callback:function(t){e.$set(e.editingColumn,"newType",t)},expression:"editingColumn.newType"}},e._l(e.dataTypeList,(function(e){return a("el-option",{key:e,attrs:{label:e,value:e}})})),1)],1),e._v(" "),a("el-form-item",{attrs:{label:"长度"}},[a("el-input-number",{staticStyle:{width:"100%"},attrs:{min:0,controls:!1},model:{value:e.editingColumn.newLength,callback:function(t){e.$set(e.editingColumn,"newLength",t)},expression:"editingColumn.newLength"}})],1),e._v(" "),a("el-form-item",{attrs:{label:"注释"}},[a("el-input",{attrs:{placeholder:"字段注释"},model:{value:e.editingColumn.newComment,callback:function(t){e.$set(e.editingColumn,"newComment",t)},expression:"editingColumn.newComment"}})],1)],1),e._v(" "),a("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[a("el-button",{attrs:{size:"small"},on:{click:function(t){e.editColumnDialogVisible=!1}}},[e._v("取消")]),e._v(" "),a("el-button",{attrs:{size:"small",type:"primary",loading:e.editColumnLoading},on:{click:e.submitEditColumn}},[e._v("确定修改")])],1)],1)],1)},l=[],o=a("b85c"),i=(a("6762"),a("2fdb"),a("ac6a"),a("7f7f"),a("c5f6"),a("f352")),s={name:"AlterTable",data:function(){return{datasourceId:null,datasourceName:"",datasourceType:"",schema:"",tableName:"",tableForm:{tableName:"",tableComment:""},existingColumns:[],loading:!1,newColumns:[],dataTypeGroups:[{label:"数值类型",options:["int","bigint","smallint","tinyint","decimal","numeric","float","double","real"]},{label:"字符类型",options:["varchar","char","text","longtext","mediumtext","tinytext"]},{label:"日期时间",options:["date","time","datetime","timestamp","year"]},{label:"其他类型",options:["boolean","json","jsonb","uuid","bytea","blob"]}],dataTypeList:["int","bigint","smallint","tinyint","decimal","numeric","float","double","real","varchar","char","text","longtext","mediumtext","tinytext","date","time","datetime","timestamp","year","boolean","json","jsonb","uuid","bytea","blob"],submitting:!1,sqlDialogVisible:!1,generatedSQL:"",editColumnDialogVisible:!1,editColumnLoading:!1,editingColumn:{name:"",type:"",newName:"",newType:"",newLength:null,newComment:""}}},created:function(){this.initFromRoute()},watch:{$route:function(e){e&&e.query&&this.initFromRoute()}},methods:{initFromRoute:function(){this.datasourceId=Number(this.$route.query.datasourceId),this.datasourceName=this.$route.query.datasourceName||"未知数据源",this.datasourceType=this.$route.query.datasourceType||"",this.schema=this.$route.query.schema||"",this.tableName=this.$route.query.tableName||"",this.tableForm.tableName=this.tableName,this.loadExistingColumns()},goBack:function(){this.$router.back()},loadExistingColumns:function(){var e=this;if(this.datasourceId&&this.tableName){this.loading=!0;var t={datasourceId:this.datasourceId,tableName:this.tableName};this.schema&&(t.tableSchema=this.schema),Object(i["i"])(t).then((function(t){e.existingColumns=(t||[]).map((function(e){return{name:e.name,type:e.type||"",length:e.length,nullable:1===e.isnull,primaryKey:e.ifPrimaryKey||!1,comment:e.comment||""}})),e.loading=!1})).catch((function(){e.loading=!1,e.$message.error("加载字段信息失败")}))}},addNewColumn:function(){this.newColumns.push({name:"",type:"varchar",length:255,nullable:!0,defaultValue:"",comment:""})},removeNewColumn:function(e){this.newColumns.splice(e,1)},editColumn:function(e){this.editingColumn={name:e.name,type:e.type,newName:e.name,newType:e.type,newLength:e.length,newComment:e.comment},this.editColumnDialogVisible=!0},submitEditColumn:function(){var e=this;if(this.editingColumn.newName)if(this.editingColumn.newType){this.editColumnLoading=!0;var t={datasourceId:this.datasourceId,tableName:this.tableName,tableSchema:this.schema||null,alterType:"MODIFY_COLUMN",columnName:this.editingColumn.name,newName:this.editingColumn.newName,newType:this.editingColumn.newType,newLength:this.editingColumn.newLength,newComment:this.editingColumn.newComment};Object(i["a"])(t).then((function(){e.$message.success("修改字段成功"),e.editColumnDialogVisible=!1,e.editColumnLoading=!1,e.loadExistingColumns(),e.$router.push({path:"/datax/integration/database",query:{datasourceId:e.datasourceId,datasourceName:e.datasourceName,datasourceType:e.datasourceType,schema:e.schema,refresh:Date.now()}})})).catch((function(t){e.editColumnLoading=!1,e.$message.error(t.msg||"修改字段失败")}))}else this.$message.warning("请选择数据类型");else this.$message.warning("请输入字段名")},dropColumn:function(e){var t=this;this.$confirm('确认删除字段 "'.concat(e.name,'" 吗？此操作不可恢复！'),"警告",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning",confirmButtonClass:"el-button--danger"}).then((function(){var a={datasourceId:t.datasourceId,tableName:t.tableName,tableSchema:t.schema||null,alterType:"DROP_COLUMN",columnName:e.name};Object(i["a"])(a).then((function(){t.$message.success("删除字段成功"),t.loadExistingColumns(),t.$router.push({path:"/datax/integration/database",query:{datasourceId:t.datasourceId,datasourceName:t.datasourceName,datasourceType:t.datasourceType,schema:t.schema,refresh:Date.now()}})})).catch((function(e){t.$message.error(e.msg||"删除字段失败")}))})).catch((function(){}))},updateTableComment:function(){var e=this,t={datasourceId:this.datasourceId,tableName:this.tableName,tableSchema:this.schema||null,alterType:"MODIFY_COMMENT",tableComment:this.tableForm.tableComment};Object(i["a"])(t).then((function(){e.$message.success("修改表注释成功"),e.$router.push({path:"/datax/integration/database",query:{datasourceId:e.datasourceId,datasourceName:e.datasourceName,datasourceType:e.datasourceType,schema:e.schema,refresh:Date.now()}})})).catch((function(t){e.$message.error(t.msg||"修改表注释失败")}))},generateSQL:function(){var e,t="postgresql"===this.datasourceType,a="mysql"===this.datasourceType;e=t?this.schema?'"'.concat(this.schema,'"."').concat(this.tableName,'"'):'"'.concat(this.tableName,'"'):"`".concat(this.tableName,"`");var n=[];return this.newColumns.forEach((function(l){if(l.name){var o=t?'"':"`",i="".concat(o).concat(l.name).concat(o," ").concat(l.type);l.length&&["varchar","char","decimal","numeric"].includes(l.type.toLowerCase())&&(i+="(".concat(l.length,")")),a&&l.length&&["int","bigint","smallint","tinyint"].includes(l.type.toLowerCase())&&(i+="(".concat(l.length,")")),l.nullable||(i+=" NOT NULL"),l.defaultValue&&(i+=" DEFAULT ".concat(l.defaultValue)),a&&l.comment&&(i+=" COMMENT '".concat(l.comment,"'")),n.push("ALTER TABLE ".concat(e," ADD COLUMN ").concat(i,";")),t&&l.comment&&n.push("COMMENT ON COLUMN ".concat(e,".").concat(o).concat(l.name).concat(o," IS '").concat(l.comment,"';"))}})),n.join("\n\n")},previewSQL:function(){0!==this.newColumns.length?(this.generatedSQL=this.generateSQL(),this.sqlDialogVisible=!0):this.$message.warning("请先添加新字段")},copySQL:function(){var e=this;navigator.clipboard.writeText(this.generatedSQL).then((function(){e.$message.success("SQL已复制到剪贴板")})).catch((function(){e.$message.error("复制失败")}))},handleSubmit:function(){var e=this;if(0!==this.newColumns.length){var t,a=Object(o["a"])(this.newColumns);try{for(a.s();!(t=a.n()).done;){var n=t.value;if(!n.name)return void this.$message.warning("字段名不能为空");if(!n.type)return void this.$message.warning("请选择数据类型")}}catch(s){a.e(s)}finally{a.f()}this.submitting=!0;var l={datasourceId:this.datasourceId,tableName:this.tableName,tableSchema:this.schema||null,alterType:"ADD_COLUMNS",columns:this.newColumns.map((function(e){return{name:e.name,type:e.type,length:e.length,nullable:e.nullable,defaultValue:e.defaultValue,comment:e.comment}}))};Object(i["a"])(l).then((function(){e.$message.success("添加字段成功"),e.submitting=!1,e.newColumns=[],e.loadExistingColumns(),e.$router.push({path:"/datax/integration/database",query:{datasourceId:e.datasourceId,datasourceName:e.datasourceName,datasourceType:e.datasourceType,schema:e.schema,refresh:Date.now()}})})).catch((function(t){e.submitting=!1,e.$message.error(t.msg||"添加字段失败")}))}else this.$message.warning("请先添加新字段")}}},r=s,u=(a("6764"),a("2877")),c=Object(u["a"])(r,n,l,!1,null,"4b4e244c",null);t["default"]=c.exports},6764:function(e,t,a){"use strict";a("8a25")},"8a25":function(e,t,a){},f352:function(e,t,a){"use strict";a.d(t,"l",(function(){return l})),a.d(t,"m",(function(){return o})),a.d(t,"k",(function(){return i})),a.d(t,"g",(function(){return s})),a.d(t,"i",(function(){return r})),a.d(t,"h",(function(){return u})),a.d(t,"c",(function(){return c})),a.d(t,"d",(function(){return m})),a.d(t,"f",(function(){return d})),a.d(t,"a",(function(){return p})),a.d(t,"e",(function(){return h})),a.d(t,"j",(function(){return b})),a.d(t,"b",(function(){return f}));var n=a("b775");function l(e){return Object(n["a"])({url:"/api/metadata/getTables",method:"get",params:e})}function o(e){return Object(n["a"])({url:"/api/metadata/getViews",method:"get",params:e})}function i(e){return Object(n["a"])({url:"/api/metadata/getDBSchema",method:"get",params:e})}function s(e){return Object(n["a"])({url:"/api/metadata/getColumns",method:"get",params:e})}function r(e){return Object(n["a"])({url:"/api/metadata/getColumnsInfo",method:"get",params:e})}function u(e){return Object(n["a"])({url:"/api/metadata/getColumnsByQuerySql",method:"get",params:e})}function c(e){return Object(n["a"])({url:"/api/metadata/createTable",method:"post",params:e})}function m(e){return Object(n["a"])({url:"/api/metadata/createTable",method:"post",data:e})}function d(e){return Object(n["a"])({url:"/api/metadata/dropTable",method:"delete",params:e})}function p(e){return Object(n["a"])({url:"/api/metadata/alterTable",method:"post",data:e})}function h(e){return Object(n["a"])({url:"/api/metadata/createView",method:"post",data:e})}function b(e){return Object(n["a"])({url:"/api/metadata/getIndexes",method:"get",params:e})}function f(e){return Object(n["a"])({url:"/api/metadata/createIndex",method:"post",data:e})}}}]);