(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-6518f912"],{1599:function(e,t,a){"use strict";a("a5f6")},"5d9e":function(e,t,a){"use strict";a.r(t);var n=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"app-container"},[a("el-page-header",{attrs:{content:"创建表"},on:{back:e.goBack}},[a("template",{slot:"content"},[a("span",[e._v("创建表")]),e._v(" "),a("el-tag",{staticStyle:{"margin-left":"10px"},attrs:{size:"small"}},[e._v(e._s(e.datasourceName))]),e._v(" "),e.schema?a("el-tag",{staticStyle:{"margin-left":"5px"},attrs:{size:"small",type:"info"}},[e._v(e._s(e.schema))]):e._e()],1)],2),e._v(" "),a("el-card",{staticClass:"form-card"},[a("div",{attrs:{slot:"header"},slot:"header"},[a("span",[e._v("表基本信息")])]),e._v(" "),a("el-form",{ref:"tableForm",attrs:{model:e.tableForm,rules:e.tableRules,"label-width":"100px"}},[a("el-row",{attrs:{gutter:20}},[a("el-col",{attrs:{span:8}},[a("el-form-item",{attrs:{label:"表名",prop:"tableName"}},[a("el-input",{attrs:{placeholder:"请输入表名"},model:{value:e.tableForm.tableName,callback:function(t){e.$set(e.tableForm,"tableName",t)},expression:"tableForm.tableName"}})],1)],1),e._v(" "),a("el-col",{attrs:{span:16}},[a("el-form-item",{attrs:{label:"表注释",prop:"tableComment"}},[a("el-input",{attrs:{placeholder:"请输入表注释"},model:{value:e.tableForm.tableComment,callback:function(t){e.$set(e.tableForm,"tableComment",t)},expression:"tableForm.tableComment"}})],1)],1)],1)],1)],1),e._v(" "),a("el-card",{staticClass:"form-card"},[a("div",{staticClass:"card-header",attrs:{slot:"header"},slot:"header"},[a("span",[e._v("字段列表")]),e._v(" "),a("el-button",{attrs:{type:"primary",size:"small",icon:"el-icon-plus"},on:{click:e.addColumn}},[e._v("添加字段")])],1),e._v(" "),a("el-table",{staticStyle:{width:"100%"},attrs:{data:e.columns,border:"",stripe:"",size:"small"}},[a("el-table-column",{attrs:{type:"index",label:"序号",width:"60",align:"center"}}),e._v(" "),a("el-table-column",{attrs:{prop:"name",label:"字段名","min-width":"150"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-input",{attrs:{size:"small",placeholder:"字段名"},model:{value:t.row.name,callback:function(a){e.$set(t.row,"name",a)},expression:"scope.row.name"}})]}}])}),e._v(" "),a("el-table-column",{attrs:{prop:"type",label:"数据类型",width:"140"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-select",{attrs:{size:"small",filterable:"","allow-create":"",placeholder:"类型"},model:{value:t.row.type,callback:function(a){e.$set(t.row,"type",a)},expression:"scope.row.type"}},e._l(e.dataTypeGroups,(function(t){return a("el-option-group",{key:t.label,attrs:{label:t.label}},e._l(t.options,(function(e){return a("el-option",{key:e,attrs:{label:e,value:e}})})),1)})),1)]}}])}),e._v(" "),a("el-table-column",{attrs:{prop:"length",label:"长度",width:"100"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-input-number",{attrs:{size:"small",min:0,controls:!1,placeholder:"长度"},model:{value:t.row.length,callback:function(a){e.$set(t.row,"length",a)},expression:"scope.row.length"}})]}}])}),e._v(" "),a("el-table-column",{attrs:{prop:"nullable",label:"可为空",width:"80",align:"center"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-checkbox",{model:{value:t.row.nullable,callback:function(a){e.$set(t.row,"nullable",a)},expression:"scope.row.nullable"}})]}}])}),e._v(" "),a("el-table-column",{attrs:{prop:"primaryKey",label:"主键",width:"80",align:"center"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-checkbox",{on:{change:function(a){return e.handlePrimaryKeyChange(t.$index)}},model:{value:t.row.primaryKey,callback:function(a){e.$set(t.row,"primaryKey",a)},expression:"scope.row.primaryKey"}})]}}])}),e._v(" "),a("el-table-column",{attrs:{prop:"autoIncrement",label:"自增",width:"80",align:"center"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-checkbox",{attrs:{disabled:!t.row.primaryKey},model:{value:t.row.autoIncrement,callback:function(a){e.$set(t.row,"autoIncrement",a)},expression:"scope.row.autoIncrement"}})]}}])}),e._v(" "),a("el-table-column",{attrs:{prop:"defaultValue",label:"默认值",width:"120"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-input",{attrs:{size:"small",placeholder:"默认值"},model:{value:t.row.defaultValue,callback:function(a){e.$set(t.row,"defaultValue",a)},expression:"scope.row.defaultValue"}})]}}])}),e._v(" "),a("el-table-column",{attrs:{prop:"comment",label:"注释","min-width":"150"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-input",{attrs:{size:"small",placeholder:"注释"},model:{value:t.row.comment,callback:function(a){e.$set(t.row,"comment",a)},expression:"scope.row.comment"}})]}}])}),e._v(" "),a("el-table-column",{attrs:{label:"操作",width:"100",align:"center",fixed:"right"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-button",{attrs:{type:"text",size:"small",icon:"el-icon-arrow-up",disabled:0===t.$index},on:{click:function(a){return e.moveColumn(t.$index,-1)}}}),e._v(" "),a("el-button",{attrs:{type:"text",size:"small",icon:"el-icon-arrow-down",disabled:t.$index===e.columns.length-1},on:{click:function(a){return e.moveColumn(t.$index,1)}}}),e._v(" "),a("el-button",{staticStyle:{color:"#F56C6C"},attrs:{type:"text",size:"small",icon:"el-icon-delete"},on:{click:function(a){return e.removeColumn(t.$index)}}})]}}])})],1)],1),e._v(" "),a("div",{staticClass:"footer-actions"},[a("el-button",{on:{click:e.goBack}},[e._v("取消")]),e._v(" "),a("el-button",{attrs:{type:"info"},on:{click:e.previewSQL}},[e._v("预览SQL")]),e._v(" "),a("el-button",{attrs:{type:"primary",loading:e.submitting},on:{click:e.handleSubmit}},[e._v("创建表")])],1),e._v(" "),a("el-dialog",{attrs:{title:"创建表SQL预览",visible:e.sqlDialogVisible,width:"600px"},on:{"update:visible":function(t){e.sqlDialogVisible=t}}},[a("pre",{staticClass:"sql-preview"},[e._v(e._s(e.generatedSQL))]),e._v(" "),a("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[a("el-button",{attrs:{size:"small"},on:{click:function(t){e.sqlDialogVisible=!1}}},[e._v("关闭")]),e._v(" "),a("el-button",{attrs:{size:"small",type:"primary"},on:{click:e.copySQL}},[e._v("复制SQL")])],1)])],1)},o=[],l=(a("7514"),a("6762"),a("2fdb"),a("7f7f"),a("ac6a"),a("c5f6"),a("f352")),r={name:"CreateTable",data:function(){return{datasourceId:null,datasourceName:"",datasourceType:"",schema:"",tableForm:{tableName:"",tableComment:""},tableRules:{tableName:[{required:!0,message:"请输入表名",trigger:"blur"},{pattern:/^[a-zA-Z_][a-zA-Z0-9_]*$/,message:"表名只能包含字母、数字和下划线，且不能以数字开头",trigger:"blur"}]},columns:[{name:"id",type:"bigint",length:null,nullable:!1,primaryKey:!0,autoIncrement:!0,defaultValue:"",comment:"主键ID"}],dataTypeGroups:[{label:"数值类型",options:["int","bigint","smallint","tinyint","decimal","numeric","float","double","real"]},{label:"字符类型",options:["varchar","char","text","longtext","mediumtext"]},{label:"日期时间",options:["date","time","datetime","timestamp","year"]},{label:"其他类型",options:["boolean","json","jsonb","uuid","bytea","blob"]}],submitting:!1,sqlDialogVisible:!1,generatedSQL:""}},created:function(){this.initFromRoute()},watch:{$route:function(e){e&&e.query&&this.initFromRoute()}},methods:{initFromRoute:function(){this.datasourceId=Number(this.$route.query.datasourceId),this.datasourceName=this.$route.query.datasourceName||"未知数据源",this.datasourceType=this.$route.query.datasourceType||"",this.schema=this.$route.query.schema||""},goBack:function(){this.$router.back()},addColumn:function(){this.columns.push({name:"",type:"varchar",length:255,nullable:!0,primaryKey:!1,autoIncrement:!1,defaultValue:"",comment:""})},removeColumn:function(e){this.columns.length<=1?this.$message.warning("至少保留一个字段"):this.columns.splice(e,1)},moveColumn:function(e,t){var a=e+t,n=this.columns[e];this.$set(this.columns,e,this.columns[a]),this.$set(this.columns,a,n)},handlePrimaryKeyChange:function(e){this.columns[e].primaryKey&&(this.columns.forEach((function(t,a){a!==e&&(t.primaryKey=!1)})),this.columns[e].nullable=!1)},generateSQL:function(){var e,t="postgresql"===this.datasourceType,a="mysql"===this.datasourceType;e=t?this.schema?'"'.concat(this.schema,'"."').concat(this.tableForm.tableName,'"'):'"'.concat(this.tableForm.tableName,'"'):"`".concat(this.tableForm.tableName,"`");var n="CREATE TABLE ".concat(e," (\n"),o=this.columns.map((function(e){var n=t?'"':"`",o="  ".concat(n).concat(e.name).concat(n," ");return e.autoIncrement&&t?o+="bigint"===e.type.toLowerCase()?"BIGSERIAL":"SERIAL":(o+=e.type,e.length&&["varchar","char","decimal","numeric"].includes(e.type.toLowerCase())&&(o+="(".concat(e.length,")")),a&&e.length&&["int","bigint","smallint","tinyint"].includes(e.type.toLowerCase())&&(o+="(".concat(e.length,")"))),e.nullable||(o+=" NOT NULL"),e.autoIncrement&&a&&(o+=" AUTO_INCREMENT"),e.defaultValue&&!e.autoIncrement&&(o+=" DEFAULT ".concat(e.defaultValue)),a&&e.comment&&(o+=" COMMENT '".concat(e.comment,"'")),o}));n+=o.join(",\n");var l=t?'"':"`",r=this.columns.filter((function(e){return e.primaryKey})).map((function(e){return"".concat(l).concat(e.name).concat(l)}));if(r.length>0&&(n+=",\n  PRIMARY KEY (".concat(r.join(", "),")")),n+="\n)",a&&(n+=" ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci",this.tableForm.tableComment&&(n+=" COMMENT='".concat(this.tableForm.tableComment,"'"))),n+=";",t&&this.tableForm.tableComment&&(n+="\n\nCOMMENT ON TABLE ".concat(e," IS '").concat(this.tableForm.tableComment,"';")),t){var c=this.columns.filter((function(e){return e.comment})).map((function(t){return"COMMENT ON COLUMN ".concat(e,'."').concat(t.name,"\" IS '").concat(t.comment,"';")}));c.length>0&&(n+="\n\n"+c.join("\n"))}return n},previewSQL:function(){this.validateForm()&&(this.generatedSQL=this.generateSQL(),this.sqlDialogVisible=!0)},copySQL:function(){var e=this;navigator.clipboard.writeText(this.generatedSQL).then((function(){e.$message.success("SQL已复制到剪贴板")})).catch((function(){e.$message.error("复制失败")}))},validateForm:function(){if(!this.tableForm.tableName)return this.$message.warning("请输入表名"),!1;if(0===this.columns.length)return this.$message.warning("请至少添加一个字段"),!1;var e=this.columns.find((function(e){return!e.name}));if(e)return this.$message.warning("字段名不能为空"),!1;var t=this.columns.find((function(e){return!e.type}));return!t||(this.$message.warning("字段类型不能为空"),!1)},handleSubmit:function(){var e=this;console.log("handleSubmit called"),console.log("datasourceId:",this.datasourceId),console.log("tableName:",this.tableForm.tableName),console.log("columns:",this.columns),this.validateForm()?(console.log("validateForm passed"),this.$confirm("确认创建该表吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((function(){console.log("confirm dialog confirmed"),e.submitting=!0;var t={datasourceId:e.datasourceId,tableName:e.tableForm.tableName,tableComment:e.tableForm.tableComment,tableSchema:e.schema,columns:e.columns.map((function(e){return{name:e.name,type:e.type,length:e.length,nullable:e.nullable,primaryKey:e.primaryKey,autoIncrement:e.autoIncrement,defaultValue:e.defaultValue,comment:e.comment}}))};console.log("request data:",JSON.stringify(t)),Object(l["d"])(t).then((function(t){console.log("createTable success:",t),e.submitting=!1,e.$message.success("表创建成功"),e.$router.push({path:"/datax/integration/database",query:{datasourceId:e.datasourceId,datasourceName:e.datasourceName,datasourceType:e.datasourceType,schema:e.schema,refresh:Date.now()}})})).catch((function(t){console.log("createTable error:",t),e.submitting=!1,e.$message.error("创建失败: "+(t.message||"未知错误"))}))})).catch((function(){console.log("confirm dialog cancelled")}))):console.log("validateForm failed")}}},c=r,i=(a("1599"),a("2877")),s=Object(i["a"])(c,n,o,!1,null,"0481b3e8",null);t["default"]=s.exports},7514:function(e,t,a){"use strict";var n=a("5ca1"),o=a("0a49")(5),l="find",r=!0;l in[]&&Array(1)[l]((function(){r=!1})),n(n.P+n.F*r,"Array",{find:function(e){return o(this,e,arguments.length>1?arguments[1]:void 0)}}),a("9c6c")(l)},a5f6:function(e,t,a){},f352:function(e,t,a){"use strict";a.d(t,"l",(function(){return o})),a.d(t,"m",(function(){return l})),a.d(t,"k",(function(){return r})),a.d(t,"g",(function(){return c})),a.d(t,"i",(function(){return i})),a.d(t,"h",(function(){return s})),a.d(t,"c",(function(){return u})),a.d(t,"d",(function(){return m})),a.d(t,"f",(function(){return d})),a.d(t,"a",(function(){return p})),a.d(t,"e",(function(){return b})),a.d(t,"j",(function(){return f})),a.d(t,"b",(function(){return h}));var n=a("b775");function o(e){return Object(n["a"])({url:"/api/metadata/getTables",method:"get",params:e})}function l(e){return Object(n["a"])({url:"/api/metadata/getViews",method:"get",params:e})}function r(e){return Object(n["a"])({url:"/api/metadata/getDBSchema",method:"get",params:e})}function c(e){return Object(n["a"])({url:"/api/metadata/getColumns",method:"get",params:e})}function i(e){return Object(n["a"])({url:"/api/metadata/getColumnsInfo",method:"get",params:e})}function s(e){return Object(n["a"])({url:"/api/metadata/getColumnsByQuerySql",method:"get",params:e})}function u(e){return Object(n["a"])({url:"/api/metadata/createTable",method:"post",params:e})}function m(e){return Object(n["a"])({url:"/api/metadata/createTable",method:"post",data:e})}function d(e){return Object(n["a"])({url:"/api/metadata/dropTable",method:"delete",params:e})}function p(e){return Object(n["a"])({url:"/api/metadata/alterTable",method:"post",data:e})}function b(e){return Object(n["a"])({url:"/api/metadata/createView",method:"post",data:e})}function f(e){return Object(n["a"])({url:"/api/metadata/getIndexes",method:"get",params:e})}function h(e){return Object(n["a"])({url:"/api/metadata/createIndex",method:"post",data:e})}}}]);